# Backend_на_Nodejs

## Backend_на_Nodejs

**Версия:** 1.0
**Дата последнего обновления:** 2023-10-27
**Автор:** Максим Петров, Инженер Backend

**Введение**

Этот документ описывает архитектуру и особенности backend-части платформы Butterboard, разработанной на Node.js. Он предназначен для команды разработчиков, технических специалистов поддержки и других заинтересованных сторон.  Основной задачей backend является обеспечение стабильной работы чат-бота, интеграция с RAG (Retrieval-Augmented Generation) системой, обработка запросов от frontend, управление базой данных сотрудников и сценариев, а также обеспечение безопасности и масштабируемости системы.  В рамках MVP, backend отвечает за:

*   Прием и обработку запросов от чат-бота.
*   Вызов RAG для поиска релевантной информации.
*   Формирование ответа для чат-бота.
*   Управление данными о сотрудниках (профиль, роль, сценарий).
*   Аутентификацию и авторизацию пользователей.
*   Логирование событий и ошибок.

**Архитектура**

Backend Butterboard построен на основе микросервисной архитектуры, что обеспечивает гибкость, масштабируемость и отказоустойчивость.  Основные микросервисы:

*   **Authentication Service:**  Отвечает за аутентификацию и авторизацию пользователей (сотрудников, HR, руководителей). Использует JWT (JSON Web Tokens) для безопасной передачи информации о пользователе.
*   **Employee Service:** Управляет данными о сотрудниках, включая профили, роли, сценарии, и особенности.  Использует PostgreSQL для хранения данных.
*   **Scenario Service:**  Отвечает за управление сценариями онбординга.  Содержит определения этапов, инструкций и документов, связанных с каждой ролью.
*   **RAG Service:**  Интегрирован с внешней системой RAG (в текущей реализации - OpenAI Embeddings и векторная база данных ChromaDB).  Принимает запрос от чат-бота, ищет релевантную информацию в базе знаний, и возвращает ее для генерации ответа.
*   **Chatbot Service:**  Основной сервис, принимающий запросы от frontend, обрабатывает их, используя RAG Service, и формирует ответ для чат-бота.  Также отслеживает прогресс сотрудника в сценарии.

**Технологический стек**

*   **Язык программирования:** Node.js (v16.14.2 - текущая версия)
*   **Фреймворк:** Express.js (v4.17.1)
*   **База данных:** PostgreSQL (v14.5)
*   **Векторная база данных:** ChromaDB
*   **Библиотеки и инструменты:**
    *   `dotenv`:  Для загрузки переменных окружения.
    *   `cors`:  Для обработки кросс-доменных запросов.
    *   `helmet`:  Для защиты от распространенных атак.
    *   `morgan`:  Для логирования запросов.
    *   `bcrypt`:  Для хеширования паролей.
    *   `jsonwebtoken`:  Для работы с JWT.
    *   `pg`:  Для взаимодействия с PostgreSQL.
    *   `openai`: Для работы с OpenAI API (включая embeddings).
    *   `socket.io`: Для реализации WebSocket-соединений (планируется для расширенных функций).

**Примеры кода**

*   **Пример аутентификации (Authentication Service):**

```javascript
// Authentication Service - /api/auth/login
const jwt = require('jsonwebtoken');
const db = require('./db'); // Предполагаемый модуль для работы с базой данных

async function login(req, res) {
  const { username, password } = req.body;

  try {
    const user = await db.query('SELECT * FROM users WHERE username = $1', [username]);

    if (user.rows.length === 0) {
      return res.status(401).json({ message: 'Invalid credentials' });
    }

    const passwordMatch = await bcrypt.compare(password, user.rows[0].password);

    if (!passwordMatch) {
      return res.status(401).json({ message: 'Invalid credentials' });
    }

    const token = jwt.sign({ userId: user.rows[0].id }, process.env.JWT_SECRET, { expiresIn: '1h' });

    return res.json({ token });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: 'Internal server error' });
  }
}
```

*   **Пример запроса к RAG Service:**

```javascript
// RAG Service - /api/rag/search
const axios = require('axios');

async function search(req, res) {
  const { query } = req.body;

  try {
    // Вызов OpenAI API для получения embeddings
    const embeddings = await axios.post('https://api.openai.com/v1/embeddings', {
      input: query,
      model: 'text-embedding-ada-002',
    });

    // Поиск наиболее релевантных документов в ChromaDB
    const results = await chroma.query({
      collection: 'butterboard_knowledge_base',
      query_vector: embeddings.data.embeddings[0],
      limit: 5,
    });

    return res.json({ results });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: 'Internal server error' });
  }
}
```

**Развертывание и мониторинг**

Backend развернут на Kubernetes кластере, используя Docker.  Мониторинг осуществляется с помощью Prometheus и Grafana.  Автоматические тесты (unit, integration, e2e) запускаются при каждом коммите в основной ветке.  Логи собираются и анализируются с помощью ELK stack (Elasticsearch, Logstash, Kibana).

**Контактная информация**

*   **Максим Петров (Lead Backend Developer):**  maxim.petrov@butterboard.online
*   **Антон Смирнов (Backend Developer):** anton.smirnov@butterboard.online
*   **Группа разработчиков Backend:**  [https://slack.com/j/t-1234567890-backend-developers](https://slack.com/j/t-1234567890-backend-developers) (ссылка на Slack)

**FAQ**

*   **Вопрос:** Как часто обновляется база знаний?
    **Ответ:**  База знаний регулярно обновляется командой HR и контент-менеджерами.  Обновления обычно происходят еженедельно.
*   **Вопрос:**  Можно ли добавлять новые сценарии?
    **Ответ:**  В текущей версии добавление новых сценариев возможно только через администратора (Антон Эйчаров - hr@butterboard.online).  В будущих версиях планируется добавление функциональности для добавления сценариев через панель управления.
*   **Вопрос:**  Как происходит интеграция с OpenAI?
    **Ответ:**  Используется OpenAI API для генерации embeddings и, в будущем, для генерации ответов чат-бота.  Ключ API хранится в безопасном хранилище секретов.
*   **Вопрос:**  Какие меры безопасности используются?
    **Ответ:**  Используется HTTPS для шифрования трафика, JWT для аутентификации, bcrypt для хеширования паролей, и регулярное сканирование на уязвимости.

**Дальнейшие улучшения**

*   Внедрение WebSocket-соединений для реализации расширенных функций чат-бота (например, push-уведомления о прогрессе).
*   Разработка API для интеграции с другими системами (например, системами управления персоналом).
*   Улучшение алгоритма поиска в RAG для повышения точности и релевантности результатов.
*   Добавление возможности автоматической генерации сценариев на основе ролей и должностных обязанностей.
*   Разработка панели мониторинга для HR и руководителей с расширенными метриками и аналитикой.
Вот продолжение и расширение представленного текста, с добавлением деталей и возможных направлений развития:

"...ние WebSocket-соединений для реализации расширенных функций чат-бота (например, push-уведомления о прогрессе), **что позволит мгновенно информировать пользователей о статусе их запросов, прогрессе выполнения задач и важных обновлениях.**  Это не только улучшит пользовательский опыт, но и снизит количество обращений в службу поддержки.

*   Разработка API для интеграции с другими системами (например, системами управления персоналом). **Этот API будет предоставлять возможность интеграции с HRIS (Human Resource Information System), системами управления задачами (Jira, Asana и т.д.), системами управления обучением (LMS), и CRM.  Интеграция позволит чат-боту автоматически извлекать данные о сотрудниках, задачах, обучении и клиентах, а также выполнять действия, такие как создание запросов на отпуск, добавление задач, отправка уведомлений и многое другое.**  Важно обеспечить безопасность и соответствие требованиям GDPR и другим нормативным актам.

*   Улучшение алгоритма поиска в RAG (Retrieval-Augmented Generation) для повышения точности и релевантности результатов. **Будет проведена оптимизация базы знаний, включая использование более эффективных методов индексации и векторного представления данных.  Внедрение новых методов ранжирования результатов, таких как использование контекстного обучения и анализа семантической близости, позволит чат-боту предоставлять более точные и релевантные ответы.  Также планируется интеграция с внешними источниками информации, такими как базы данных знаний компании и корпоративные вики, для расширения охвата и глубины ответов.**  Будет реализован A/B тестирование различных алгоритмов для определения наиболее эффективного.

*   Добавление возможности автоматической генерации сценариев на основе ролей и должностных обязанностей. **Чат-бот сможет анализировать профили пользователей (например, на основе их должности, отдела и опыта) и автоматически предлагать релевантные сценарии поддержки и помощи.  Например, для сотрудника отдела продаж будет предложен сценарий по обработке запросов клиентов, а для сотрудника IT – по решению проблем с оборудованием.  Эти сценарии будут динамически адаптироваться к потребностям пользователя и его текущему контексту.**  Это значительно сократит время отклика и повысит эффективность работы сотрудников.

*   Разработка панели мониторинга для HR и руководителей с расширенными метриками и аналитикой. **Панель мониторинга будет отображать ключевые показатели эффективности (KPI) чат-бота, такие как количество обработанных запросов, среднее время ответа, удовлетворенность пользователей, частота использования различных сценариев, а также выявлять наиболее распространенные вопросы и проблемы.  Будут добавлены возможности для сегментации данных по ролям, отделам и другим параметрам, что позволит HR и руководителям выявлять тенденции и принимать обоснованные решения.  Также планируется интеграция с системами отчетности для автоматической генерации отчетов и дашбордов.**  Будет реализована возможность настройки панели мониторинга под конкретные потребности различных групп пользователей.

**В дальнейшем планируется добавить следующие функции:**

*   **Поддержка нескольких языков.**
*   **Интеграция с системами распознавания речи и синтеза речи для голосового взаимодействия.**
*   **Внедрение системы машинного обучения для непрерывного улучшения производительности и адаптации к изменяющимся потребностям пользователей.**
*   **Разработка системы обратной связи для сбора отзывов пользователей и использования их для улучшения качества работы чат-бота.**

**Ключевая цель – создание интеллектуального помощника, который не только автоматизирует рутинные задачи, но и повышает производительность, улучшает пользовательский опыт и способствует развитию бизнеса.**"

---

Этот расширенный вариант более подробно описывает каждую из пунктов, добавляет возможные реализации и перспективные направления развития проекта.  Надеюсь, это поможет!